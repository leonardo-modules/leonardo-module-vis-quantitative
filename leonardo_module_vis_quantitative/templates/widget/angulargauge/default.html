{% extends widget.get_base_template %}

{% block content %}
<div id="angular_gauge_{{ widget.fe_identifier }}"></div>

<script type="text/javascript">

function redraw_angular_gauge_{{ widget.id }}(value){
  var placeholder = '#angular_gauge_{{ widget.fe_identifier }}',
      parent_box = $(placeholder).parent(),
      width = parent_box.width(),
      min,
      max;

  d3.select(placeholder+" svg").remove();

  config = {
    'size': width,
    'label': 'Angular',
    'placeholder': placeholder,
    'min': undefined != min ? min : 0,
    'max': undefined != max ? max : 100,
    'minorTicks': 5,
    'data': value,
    'data_source': "{{ widget.get_data }}"
  };

  var range = config.max - config.min;

  config.yellowZones = [{ from: config.min + range*0.75, to: config.min + range*0.9 }];
  config.redZones = [{ from: config.min + range*0.9, to: config.max }];
  
  var gauge = new angular_gauge_pointer(config);

  gauge.render();

  function loop_angular_gauge(){
    $.ajax({
        type: 'POST',
        url: '/data/data/',
        data: {widget_id:$("#angular_gauge_{{ widget.fe_identifier }}").closest("div.leonardo-widget").attr('id')},
        success: function (data) {
            console.log(data);
        },
        async: false
    }).done(function(data) {
      gauge.redraw(data.data.value);
    });

    setTimeout(function() {
      loop_angular_gauge();
    }, 5000);
  }
  loop_angular_gauge();
}

$(document).ready(function() {
  $.ajax({
      type: 'POST',
      url: '/data/data/',
      data: {widget_id:$("#angular_gauge_{{ widget.fe_identifier }}").closest("div.leonardo-widget").attr('id')},
      success: function (data) {
          console.log(data);
      },
      async: false
  }).done(function(data) {
    redraw_angular_gauge_{{ widget.id }}(data.data.value);
  });
  window.addEventListener("resize", redraw_angular_gauge_{{ widget.id }});
});

</script>
{% endblock %}
